<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.2"/>
<title>Futsal Season Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0b0d;
  --panel:#16161a;
  --panel-2:#1a1a1f;
  --border:rgba(255,255,255,.06);
  --border-hover:rgba(255,255,255,.12);
  --muted:rgba(255,255,255,.65);
  --muted-2:rgba(255,255,255,.45);
  --white:#fff;
  --red:#ff2d55;
  --red-2:#ff0033;
  --green:#39ff14;
  --green-soft:rgba(57,255,20,.12);
  --ring:rgba(57,255,20,.25);
  --shadow-sm:0 2px 8px rgba(0,0,0,.15);
  --shadow-md:0 8px 32px rgba(0,0,0,.25);
  --shadow-lg:0 20px 60px rgba(0,0,0,.4);
  --shadow-glow:0 0 40px rgba(57,255,20,.15);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1200px 800px at 0% 0%, rgba(255,45,85,.08), transparent 50%),
    radial-gradient(1000px 700px at 100% 100%, rgba(57,255,20,.06), transparent 50%),
    radial-gradient(800px 800px at 50% 50%, rgba(138,43,226,.03), transparent 70%),
    var(--bg);
  color:var(--white);
  letter-spacing:-.01em;
  /* overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ---------- Layout ---------- */
.app{
  display:grid;
  grid-template-columns: 1fr 340px;
  gap:24px;
  min-height:100vh;
  padding:24px;
}
@media (max-width:1200px){
  .app{ grid-template-columns: 1fr; }
}
@media (max-width:880px){
  .app{grid-template-columns:1fr}
  .brand span, .nav .label{display:none}
}

/* ---------- Sidebar ---------- */
.sidebar{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)), var(--panel);
  border:1px solid var(--border);
  border-radius:24px;
  padding:24px;
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255,255,255,.08);
  position:relative;
  overflow:hidden;
}
.sidebar::before{
  content:'';
  position:absolute;
  inset:-100%;
  background:conic-gradient(from 0deg at 50% 50%, transparent, rgba(57,255,20,.05), transparent 60%);
  animation:rotate 15s linear infinite;
  pointer-events:none;
}
@keyframes rotate{to{transform:rotate(360deg)}}

.brand{
  display:flex; align-items:center; gap:12px; margin-bottom:24px; position:relative; z-index:1;
}
.brand .dot{
  width:16px; height:16px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fff, transparent 70%),
              linear-gradient(135deg, var(--red), var(--green));
  box-shadow: 0 0 20px rgba(255,45,85,.6), 0 0 40px rgba(57,255,20,.4), 0 4px 12px rgba(0,0,0,.3);
  animation:pulse 3s ease-in-out infinite;
}
@keyframes pulse{
  0%, 100%{transform:scale(1); opacity:1;}
  50%{transform:scale(1.1); opacity:.9;}
}
.brand span{
  font-weight:800; letter-spacing:-.02em; font-size:19px;
  background:linear-gradient(135deg, var(--white) 0%, rgba(255,255,255,.7) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 2px 10px rgba(255,255,255,.1);
}

.nav{display:flex; flex-direction:column; gap:6px; margin-top:12px; position:relative; z-index:1}
.nav a{
  display:flex; align-items:center; gap:14px;
  padding:14px 16px;
  border-radius:16px;
  text-decoration:none; color:var(--muted);
  border:1px solid transparent;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  font-weight:500;
  position:relative;
  overflow:hidden;
}
.nav a::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,.06), transparent);
  opacity:0;
  transition:opacity .3s;
}
.nav a svg{opacity:.7; transition:all .3s;}
.nav a:hover{
  background:rgba(255,255,255,.03); 
  color:var(--white); 
  border-color:var(--border-hover); 
  transform:translateX(4px);
}
.nav a:hover::before{opacity:1;}
.nav a:hover svg{opacity:1; transform:scale(1.1);}
.nav a.active{
  background:linear-gradient(135deg, rgba(57,255,20,.15), rgba(255,45,85,.12));
  color:var(--white); 
  border-color:rgba(57,255,20,.3);
  box-shadow:0 8px 24px rgba(57,255,20,.2), inset 0 1px 0 rgba(255,255,255,.1);
  font-weight:600;
}
.nav a.active svg{opacity:1;}

/* ---------- Top Bar ---------- */
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:28px; gap:20px;
}
.title{
  display:flex; flex-direction:column; gap:2px;
}
.title h1{
  margin:0; font-size:32px; letter-spacing:-.02em; font-weight:800;
  background:linear-gradient(135deg, var(--white), rgba(255,255,255,.8));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.title small{color:var(--muted-2); margin-top:4px; font-size:13px; font-weight:500;}

.search{
  display:flex; align-items:center; gap:12px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px; padding:12px 18px; min-width:280px;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--shadow-sm);
}
.search:focus-within{
  border-color:var(--border-hover);
  box-shadow:0 4px 20px rgba(0,0,0,.2), 0 0 0 3px rgba(57,255,20,.08);
  transform:translateY(-1px);
}
.search input{
  background:transparent; border:none; color:var(--white); outline:none; width:100%;
  font-size:14px; font-weight:500;
}
.search input::placeholder{color:var(--muted-2);}

.controls{
  display:flex; gap:6px; align-items:center;
  background:var(--panel);
  border:1px solid var(--border);
  padding:6px; border-radius:16px;
  box-shadow:var(--shadow-sm);
}
.btn{
  padding:11px 20px; background:transparent; border:none; color:var(--muted);
  font-weight:600; border-radius:12px; cursor:pointer; 
  transition:all .3s cubic-bezier(.4,0,.2,1);
  font-size:14px; position:relative; overflow:hidden;
}
.btn::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,.08), transparent);
  opacity:0;
  transition:opacity .3s;
}
.btn:hover{
  color:var(--white); 
  background:rgba(255,255,255,.05);
  transform:translateY(-1px);
}
.btn:hover::before{opacity:1;}
.btn.active{
  background:linear-gradient(135deg, rgba(57,255,20,.18), rgba(57,255,20,.12)); 
  color:var(--green); 
  box-shadow:0 0 0 1px var(--ring) inset, 0 4px 16px rgba(57,255,20,.25);
}

/* ---------- Cards / Grid ---------- */
.panel{
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01)),
    var(--panel);
  border:1px solid var(--border);
  border-radius:24px;
  padding:28px;
  box-shadow: var(--shadow-md);
  transition:all .4s cubic-bezier(.4,0,.2,1);
  position:relative;
  overflow:hidden;
}
.panel::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);
}
.panel:hover{
  transform:translateY(-4px); 
  border-color:rgba(57,255,20,.2);
  box-shadow:var(--shadow-lg), var(--shadow-glow);
}

.section-title{
  font-size:11px; letter-spacing:2px; text-transform:uppercase;
  color:rgba(255,255,255,.5); margin-bottom:20px; display:flex; gap:10px; align-items:center;
  font-weight:700;
}

.grid{
  display:grid; gap:18px; grid-template-columns:repeat(12, 1fr);
}
.leaderboard{grid-column:1 / -1}
.hot-streak-card{grid-column: span 6}
.stat-card{grid-column: span 3}
@media (max-width:1024px){ .hot-streak-card,.stat-card{grid-column: span 6} }
@media (max-width:720px){ .hot-streak-card,.stat-card,.leaderboard{grid-column: 1 / -1} }

/* ---------- Table ---------- */
table{width:100%; border-collapse:separate; border-spacing:0 8px}
thead th{
  font-size:10px; text-transform:uppercase; letter-spacing:1.5px; 
  color:var(--muted-2); padding:0 16px 12px 16px; text-align:left;
  border-bottom:1px solid var(--border); font-weight:700;
}
tbody tr{
  background:linear-gradient(135deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid var(--border);
  border-radius:16px; overflow:hidden;
  transition:all .3s cubic-bezier(.4,0,.2,1);
}
tbody tr:hover{
  background:linear-gradient(135deg, rgba(57,255,20,.08), rgba(57,255,20,.04)); 
  border-color:rgba(57,255,20,.3);
  transform:translateX(4px);
  box-shadow:0 4px 16px rgba(57,255,20,.15);
}
td{padding:16px; font-size:14px; font-weight:500;}

.rank{
  font-weight:800; font-size:17px; padding:8px 14px; border-radius:12px;
  color:var(--white); 
  background:linear-gradient(135deg, rgba(255,45,85,.3), rgba(255,45,85,.15)); 
  border:1px solid rgba(255,45,85,.4);
  box-shadow:0 4px 12px rgba(255,45,85,.25), inset 0 1px 0 rgba(255,255,255,.1);
  display:inline-block;
}
.rank-change{
  font-size:11px; padding:5px 8px; border-radius:10px; margin-left:10px; 
  font-weight:700; border:1px solid transparent;
  display:inline-block;
  white-space:nowrap;
}
@media (max-width:720px){
  .rank-change{
    font-size:10px;
    padding:4px 6px;
    margin-left:6px;
  }
  .rank{
    font-size:15px;
    padding:6px 10px;
  }
}
.rank-up{
  color:var(--green); 
  background:linear-gradient(135deg, rgba(57,255,20,.18), rgba(57,255,20,.1)); 
  border-color:var(--ring);
  box-shadow:0 2px 8px rgba(57,255,20,.2);
}
.rank-down{
  color:var(--red); 
  background:linear-gradient(135deg, rgba(255,45,85,.18), rgba(255,45,85,.1)); 
  border-color:rgba(255,45,85,.35);
  box-shadow:0 2px 8px rgba(255,45,85,.2);
}

.points{
  font-weight:800; font-size:16px;
  background:linear-gradient(120deg, var(--green), #c7ffc7);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 0 20px rgba(57,255,20,.3);
}

/* ---------- Metric Items ---------- */
.metric-item{
  background:linear-gradient(135deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
  border:1px solid var(--border);
  padding:18px; border-radius:16px; margin-bottom:12px;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  position:relative;
  overflow:hidden;
}
.metric-item::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
}
.metric-item:hover{
  border-color:rgba(57,255,20,.25); 
  transform:translateX(6px);
  box-shadow:0 4px 16px rgba(57,255,20,.1);
  background:linear-gradient(135deg, rgba(57,255,20,.06), rgba(255,255,255,.02));
}
.metric-player{font-weight:700; font-size:15px;}
.metric-value{color:var(--muted); font-size:13px; margin-top:8px; line-height:1.6;}
.new-player{color:var(--green); font-weight:700;}

/* ---------- Hot Streak ---------- */
.hot-streak{
  text-align:center; padding:48px 32px; border-radius:20px;
  border:1px solid rgba(57,255,20,.3);
  background:
    radial-gradient(800px 300px at 50% 0%, rgba(57,255,20,.2), transparent 60%),
    radial-gradient(600px 300px at 50% 100%, rgba(255,45,85,.15), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  position:relative; overflow:hidden;
  box-shadow:0 0 60px rgba(57,255,20,.2), inset 0 1px 0 rgba(255,255,255,.1);
}
.hot-streak::after{
  content:""; position:absolute; inset:-60%;
  background:conic-gradient(from 0deg, transparent, rgba(57,255,20,.3), rgba(255,45,85,.25), transparent);
  filter:blur(80px); animation:spin 10s linear infinite; opacity:.4;
}
@keyframes spin{to{transform:rotate(1turn)}}
.hot-streak-player{
  font-size:36px; font-weight:900; color:var(--green); letter-spacing:-.03em;
  position:relative; z-index:1;
  text-shadow:0 0 40px rgba(57,255,20,.6), 0 4px 20px rgba(0,0,0,.3);
}
.hot-streak-desc{
  color:var(--muted); position:relative; z-index:1; margin-top:12px; 
  font-size:15px; font-weight:500;
}

/* ---------- Team chips ---------- */
.weekly-team{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:14px;
}
.team-player{
  text-align:center; padding:20px 16px; border-radius:18px;
  background:linear-gradient(135deg, rgba(57,255,20,.12), rgba(57,255,20,.06));
  border:1px solid rgba(57,255,20,.3);
  transition:all .3s cubic-bezier(.4,0,.2,1);
  position:relative;
  overflow:hidden;
}
.team-player::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(57,255,20,.4), transparent);
}
.team-player:hover{
  transform:translateY(-4px) scale(1.02); 
  box-shadow:0 12px 32px rgba(57,255,20,.25);
  border-color:rgba(57,255,20,.5);
}
.team-player-name{font-weight:800; color:var(--green); font-size:15px; letter-spacing:-.01em;}
.team-player-stats{color:var(--muted); font-size:12px; margin-top:6px; font-weight:500;}

/* ---------- Right Aside ---------- */
.aside .widget+.widget{margin-top:20px}
.kpi{
  display:flex; align-items:center; gap:18px;
}
.kpi .ring{
  width:72px; height:72px; border-radius:50%;
  background: conic-gradient(var(--green) calc(var(--p)*1%), rgba(255,255,255,.08) 0);
  display:grid; place-items:center;
  border:1px solid var(--border);
  box-shadow:0 0 30px rgba(57,255,20,.3), inset 0 0 20px rgba(0,0,0,.3);
  position:relative;
}
.kpi .ring::before{
  content:'';
  position:absolute;
  inset:8px;
  border-radius:50%;
  background:var(--panel);
  border:1px solid var(--border);
}
.kpi .ring span{
  font-weight:900; font-size:16px; position:relative; z-index:1;
  background:linear-gradient(135deg, var(--green), #c7ffc7);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 14px; border-radius:999px; font-weight:700; font-size:12px;
  background:linear-gradient(135deg, rgba(255,45,85,.2), rgba(255,45,85,.12)); 
  border:1px solid rgba(255,45,85,.4);
  box-shadow:0 4px 12px rgba(255,255,255,.2), inset 0 1px 0 rgba(255,255,255,.08);
  animation:pulse-badge 2s ease-in-out infinite;
}
@keyframes pulse-badge{
  0%, 100%{transform:scale(1); opacity:1;}
  50%{transform:scale(1.05); opacity:.9;}
}
.small{font-size:12px; color:var(--muted); font-weight:500; margin-top:6px;}
.header-card{
  display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
}

/* ---------- Week selector ---------- */
.week-selector{margin-bottom:20px; text-align:center}
.week-selector select{
  padding:14px 20px; 
  background:var(--panel);
  color:var(--white);
  border:1px solid var(--border);
  border-radius:14px;
  font-weight:600;
  outline:none;
  cursor:pointer;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  font-size:14px;
  box-shadow:var(--shadow-sm);
}
.week-selector select option{
  background:var(--panel);
  color:var(--white);
  padding:10px;
}
.week-selector select:hover{
  border-color:rgba(57,255,20,.35);
  background:linear-gradient(135deg, rgba(57,255,20,.08), rgba(255,255,255,.02));
  transform:translateY(-2px);
  box-shadow:0 4px 16px rgba(57,255,20,.15);
}
.week-selector select:focus{
  border-color:rgba(57,255,20,.5);
  box-shadow:0 0 0 3px rgba(57,255,20,.15), 0 4px 16px rgba(57,255,20,.2);
}
.empty-state{
  text-align:center; 
  color:var(--muted-2); 
  padding:32px 20px;
  font-weight:500;
  font-size:14px;
}
.player-name{font-weight:600; letter-spacing:-.01em;}

/* Scrollable lists used in compact stat cards */
.scroll-list{
  max-height: 520px;
  overflow-y: auto;
  padding-right: 4px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  mask-image: linear-gradient(to bottom, rgba(0,0,0,1), rgba(0,0,0,1) 85%, rgba(0,0,0,.2));
}

/* Tighten list items slightly in scroll areas so more fit */
.scroll-list .metric-item{
  margin-bottom:10px;
  padding:16px;
}

/* Optional: subtle custom scrollbar */
.scroll-list::-webkit-scrollbar{ width: 8px; }
.scroll-list::-webkit-scrollbar-track{ background: transparent; }
.scroll-list::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.12);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,.08);
}
.scroll-list:hover::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.22); }

/* Firefox scrollbar */
.scroll-list{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.22) transparent; }

/* Mobile: keep it a bit shorter so it doesn't dominate */
@media (max-width:720px){
  .scroll-list{ max-height: 220px; }
}

/* --- Scrollable Leaderboard / Tables --- */
.scroll-table{
  max-height: 840px;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  padding-top: 4px;
  padding-right: 4px;
  border-radius: 16px;
}

/* Let tables scroll horizontally on small screens */
@media (max-width: 820px){
  .scroll-table{ overflow-x: auto; }
  .scroll-table table{ min-width: 680px; } /* keeps columns readable */
}

/* Weekly table wrapper (adds horizontal scroll when needed) */
.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.table-wrap table{ width:100%; }
@media (max-width:820px){
  .table-wrap table{ min-width: 560px; } /* fewer cols than leaderboard */
}

/* Keep table metrics intact inside scroll area */
.scroll-table table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 8px;
  margin: 0;
}

/* Sticky header */
.scroll-table thead th{
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--panel);
  box-shadow: 0 2px 4px rgba(0,0,0,.4);
  padding: 12px 16px;
  line-height: 1.25;
  white-space: nowrap;
}

.scroll-table th,
.scroll-table td{ vertical-align: middle; }

.scroll-table::-webkit-scrollbar{ width: 8px; }
.scroll-table::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.12);
  border-radius: 8px;
}
.scroll-table:hover::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.25); }
.scroll-table{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.22) transparent; }
</style>
</head>
<body>
  <div class="app">

    <!-- Main -->
    <main>
      <div class="topbar">
        <div class="title">
          <h1>Torpedo Vintervargen</h1>
          <small>2025 / 26 ‚Ä¢ Weekly stats</small>
        </div>
        <div class="header-card">
          <div class="controls">
            <button class="btn active" onclick="showView('total')">Total Season</button>
            <button class="btn" onclick="showView('weekly')">Practice View</button>
          </div>
        </div>
      </div>

      <!-- TOTAL VIEW -->
      <section id="totalView">
        <div class="grid">
          <div class="panel leaderboard">
            <div class="section-title">üèÜ Leaderboard</div>
              <div class="scroll-table">
                <table>
                  <thead>
                    <tr>
                      <th>Rank</th><th>Player</th><th>Points</th>
                      <th>Attendance</th><th>Goals</th><th>Assists</th><th>Clean Sheets</th><th>√úbertorped</th>
                    </tr>
                  </thead>
                  <tbody id="leaderboardBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel hot-streak-card">
            <div class="section-title">üî• Hot Streak</div>
            <div id="hotStreak"></div>
          </div>

          <div class="panel stat-card">
            <div class="section-title">üìä Active Streaks</div>
            <div id="activeStreaks" class="scroll-list"></div>
          </div>

          <div class="panel stat-card">
            <div class="section-title">üéØ Milestones</div>
            <div id="milestones" class="scroll-list"></div>
          </div>

          <div class="panel stat-card">
            <div class="section-title">üìà Biggest Climber</div>
            <div id="biggestClimber"></div>
          </div>

          <div class="panel stat-card">
            <div class="section-title">üìÖ Season Stats</div>
            <div id="seasonStats"></div>
          </div>
        </div>
      </section>

      <!-- WEEKLY VIEW -->
      <section id="weeklyView" style="display:none;">
        <div class="panel" style="margin-bottom:18px;">
          <div class="section-title">Week</div>
          <div class="week-selector">
            <select id="weekSelect" onchange="updatePracticeView()"></select>
          </div>
        </div>

        <div class="grid">
          <div class="panel leaderboard">
            <div class="section-title">üìã Week Stats</div>
            <!-- WRAP weekly table so it can scroll horizontally on mobile -->
            <div class="scroll-table">
              <table>
                <thead>
                  <tr>
                    <th>Player</th><th>Goals</th><th>Assists</th><th>Clean Sheets</th><th>√úbertorped</th><th>Points</th>
                  </tr>
                </thead>
                <tbody id="weeklyStatsBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel hot-streak-card">
              <div class="section-title">‚≠ê Practice Top Team</div>
              <div id="weeklyTeam"></div>
              <div style="font-size:11px;color:var(--muted-2);margin-top:16px;line-height:1.5;">
                <b>ATT:</b> Best goals+assists ‚Ä¢ <b>DEF:</b> Current CS + 30% historic avg ‚Ä¢ <b>‚òÖ:</b> Best remaining points
              </div>
            </div>
          <div class="panel stat-card">
            <div class="section-title">üÜï New Players</div>
            <div id="newPlayers" class="scroll-list"></div>
          </div>
          <div class="panel hot-streak-card">
            <div class="section-title">üöÄ Overperformance Spotlight</div>
            <div id="deviationLeader"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Aside -->
    <aside class="aside">
      <div class="panel widget">
        <div class="section-title">Season Overview</div>
        <div class="kpi">
          <div class="ring" id="seasonRing" style="--p:0"><span id="seasonPct">0%</span></div>
          <div>
            <div class="badge">Live</div>
            <div class="small" id="weeksText">0 of 0 weeks</div>
          </div>
        </div>
      </div>

      <div class="panel widget">
        <div class="section-title">Tip</div>
        <div class="small">Use <b>Practice View</b> to see the top 5 performers and any new joiners.</div>
      </div>
    </aside>
  </div>

<script>
/* ------- Data (same structure as original) ------- */
const weeklyData = [{"week":42,"date":"2025-10-14","stats":[{"name":"Arvid","attendance":1,"goals":0,"assists":0,"cleanSheet":7,"turbotorped":0},{"name":"Chris","attendance":1,"goals":2,"assists":2,"cleanSheet":8,"turbotorped":0},{"name":"Mathias","attendance":1,"goals":1,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Degen","attendance":1,"goals":0,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Marco","attendance":1,"goals":2,"assists":0,"cleanSheet":7,"turbotorped":0},{"name":"Pontus","attendance":1,"goals":2,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":2,"assists":3,"cleanSheet":4,"turbotorped":0},{"name":"Maxim","attendance":1,"goals":1,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Ayman","attendance":1,"goals":0,"assists":1,"cleanSheet":7,"turbotorped":1},{"name":"Payam","attendance":1,"goals":3,"assists":3,"cleanSheet":8,"turbotorped":0},{"name":"Saman","attendance":1,"goals":1,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":2,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":4,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":2,"assists":2,"cleanSheet":8,"turbotorped":0},{"name":"Simon A","attendance":1,"goals":3,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Anton","attendance":1,"goals":1,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Oskar","attendance":1,"goals":0,"assists":0,"cleanSheet":7,"turbotorped":0},{"name":"Erik √ñ","attendance":1,"goals":4,"assists":3,"cleanSheet":8,"turbotorped":0},{"name":"Patrik","attendance":1,"goals":1,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Alex B","attendance":1,"goals":0,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Andres","attendance":1,"goals":0,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Kim","attendance":1,"goals":2,"assists":1,"cleanSheet":8,"turbotorped":0}]},{"week":42,"date":"2025-10-16","stats":[{"name":"Lasse","attendance":1,"goals":2,"assists":2,"cleanSheet":6,"turbotorped":0},{"name":"Marco","attendance":1,"goals":3,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Simon A","attendance":1,"goals":3,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Adde","attendance":1,"goals":0,"assists":2,"cleanSheet":6,"turbotorped":0},{"name":"Pontus","attendance":1,"goals":2,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Degen","attendance":1,"goals":0,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Love B","attendance":1,"goals":2,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Love √ñ","attendance":1,"goals":1,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Malte","attendance":1,"goals":5,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Olle","attendance":1,"goals":2,"assists":3,"cleanSheet":11,"turbotorped":1},{"name":"Gurra","attendance":1,"goals":0,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Saman","attendance":1,"goals":1,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":0,"assists":3,"cleanSheet":6,"turbotorped":0},{"name":"Anton","attendance":1,"goals":1,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Abdul","attendance":1,"goals":3,"assists":1,"cleanSheet":11,"turbotorped":0},{"name":"Chris","attendance":1,"goals":1,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Erik √ñ","attendance":1,"goals":2,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":2,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":3,"assists":1,"cleanSheet":11,"turbotorped":0}]},{"week":43,"date":"2025-10-21","stats":[{"name":"Gio","attendance":1,"goals":0,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Chris","attendance":1,"goals":2,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Mathias","attendance":1,"goals":3,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Anton","attendance":1,"goals":0,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":5,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Saman","attendance":1,"goals":0,"assists":3,"cleanSheet":4,"turbotorped":0},{"name":"Abdul","attendance":1,"goals":3,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Kim","attendance":1,"goals":2,"assists":4,"cleanSheet":8,"turbotorped":0},{"name":"Marco","attendance":1,"goals":1,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Oskar","attendance":1,"goals":3,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Simon A","attendance":1,"goals":1,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":0,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":0,"assists":3,"cleanSheet":4,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":0,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Degen","attendance":1,"goals":0,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Malte","attendance":1,"goals":2,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Love √ñ","attendance":1,"goals":3,"assists":3,"cleanSheet":6,"turbotorped":0},{"name":"Milton","attendance":1,"goals":1,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Marius","attendance":1,"goals":0,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Martin J","attendance":1,"goals":2,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":1,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Olle","attendance":1,"goals":2,"assists":4,"cleanSheet":6,"turbotorped":0}]},{"week":43,"date":"2025-10-23","stats":[{"name":"Erik √ñ","attendance":1,"goals":4,"assists":2,"cleanSheet":7,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":3,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":1,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Degen","attendance":1,"goals":0,"assists":2,"cleanSheet":2,"turbotorped":0},{"name":"Malte","attendance":1,"goals":3,"assists":3,"cleanSheet":5,"turbotorped":0},{"name":"Abdul","attendance":1,"goals":0,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Love √ñ","attendance":1,"goals":1,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Gurra","attendance":1,"goals":0,"assists":3,"cleanSheet":7,"turbotorped":0},{"name":"Love B","attendance":1,"goals":3,"assists":0,"cleanSheet":2,"turbotorped":0},{"name":"Patrik","attendance":1,"goals":0,"assists":2,"cleanSheet":5,"turbotorped":0},{"name":"Saman","attendance":1,"goals":0,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Martin J","attendance":1,"goals":3,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Anton","attendance":1,"goals":2,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Adde","attendance":1,"goals":0,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":1,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":0,"assists":2,"cleanSheet":5,"turbotorped":0},{"name":"Marco","attendance":1,"goals":1,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Olle","attendance":1,"goals":1,"assists":1,"cleanSheet":7,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":5,"assists":1,"cleanSheet":2,"turbotorped":0},{"name":"Kim","attendance":1,"goals":1,"assists":2,"cleanSheet":2,"turbotorped":0},{"name":"Mathias","attendance":1,"goals":2,"assists":1,"cleanSheet":2,"turbotorped":0},{"name":"Esmet","attendance":1,"goals":3,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Ante","attendance":1,"goals":5,"assists":3,"cleanSheet":5,"turbotorped":1}]},{"week":44,"date":"2025-10-28","stats":[{"name":"Lasse","attendance":1,"goals":3,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Mathias","attendance":1,"goals":1,"assists":0,"cleanSheet":10,"turbotorped":0},{"name":"Milton","attendance":1,"goals":1,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Marius","attendance":1,"goals":1,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Payam","attendance":1,"goals":5,"assists":4,"cleanSheet":10,"turbotorped":0},{"name":"Saman","attendance":1,"goals":1,"assists":0,"cleanSheet":10,"turbotorped":0},{"name":"Olle","attendance":1,"goals":2,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Emil N","attendance":1,"goals":2,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Marco","attendance":1,"goals":0,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Adde","attendance":1,"goals":2,"assists":0,"cleanSheet":10,"turbotorped":0},{"name":"Chris","attendance":1,"goals":2,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Oskar","attendance":1,"goals":0,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Kim","attendance":1,"goals":1,"assists":2,"cleanSheet":10,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":1,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":2,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Anton","attendance":1,"goals":0,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Simon A","attendance":1,"goals":1,"assists":4,"cleanSheet":8,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":1,"assists":1,"cleanSheet":10,"turbotorped":0},{"name":"Love B","attendance":1,"goals":0,"assists":3,"cleanSheet":8,"turbotorped":1},{"name":"Erik √ñ","attendance":1,"goals":5,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":2,"assists":3,"cleanSheet":10,"turbotorped":0}]},{"week":44,"date":"2025-10-30","stats":[{"name":"Mathias","attendance":1,"goals":1,"assists":0,"cleanSheet":9,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":1,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Saman","attendance":1,"goals":0,"assists":1,"cleanSheet":9,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":0,"assists":0,"cleanSheet":9,"turbotorped":0},{"name":"Marco","attendance":1,"goals":4,"assists":1,"cleanSheet":9,"turbotorped":0},{"name":"Payam","attendance":1,"goals":5,"assists":3,"cleanSheet":9,"turbotorped":0},{"name":"Love B","attendance":1,"goals":0,"assists":4,"cleanSheet":9,"turbotorped":0},{"name":"Anton","attendance":1,"goals":1,"assists":1,"cleanSheet":9,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":4,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":1,"assists":1,"cleanSheet":6,"turbotorped":0},{"name":"Adde","attendance":1,"goals":0,"assists":1,"cleanSheet":9,"turbotorped":1},{"name":"Degen","attendance":1,"goals":0,"assists":0,"cleanSheet":9,"turbotorped":0},{"name":"Love √ñ","attendance":1,"goals":4,"assists":1,"cleanSheet":9,"turbotorped":0},{"name":"Olle","attendance":1,"goals":2,"assists":0,"cleanSheet":6,"turbotorped":0},{"name":"Gurra","attendance":1,"goals":0,"assists":2,"cleanSheet":6,"turbotorped":0},{"name":"Martin J","attendance":1,"goals":0,"assists":3,"cleanSheet":6,"turbotorped":0},{"name":"Malte","attendance":1,"goals":2,"assists":2,"cleanSheet":9,"turbotorped":0},{"name":"Erik √ñ","attendance":1,"goals":2,"assists":4,"cleanSheet":9,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":2,"assists":1,"cleanSheet":9,"turbotorped":0}]},{"week":45,"date":"2025-11-04","stats":[{"name":"Milton","attendance":1,"goals":1,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":2,"assists":3,"cleanSheet":11,"turbotorped":0},{"name":"Pontus","attendance":1,"goals":2,"assists":1,"cleanSheet":11,"turbotorped":0},{"name":"Erik √ñ","attendance":1,"goals":4,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Love √ñ","attendance":1,"goals":3,"assists":0,"cleanSheet":8,"turbotorped":0},{"name":"Oskar","attendance":1,"goals":2,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":3,"assists":1,"cleanSheet":11,"turbotorped":0},{"name":"Degen","attendance":1,"goals":0,"assists":0,"cleanSheet":11,"turbotorped":0},{"name":"Love B","attendance":1,"goals":2,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Marco","attendance":1,"goals":0,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Mathias","attendance":1,"goals":0,"assists":1,"cleanSheet":11,"turbotorped":0},{"name":"Chris","attendance":1,"goals":1,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Martin J","attendance":1,"goals":1,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Malte","attendance":1,"goals":2,"assists":4,"cleanSheet":11,"turbotorped":1},{"name":"Anton","attendance":1,"goals":0,"assists":1,"cleanSheet":8,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":1,"assists":0,"cleanSheet":11,"turbotorped":0},{"name":"Kim","attendance":1,"goals":2,"assists":2,"cleanSheet":8,"turbotorped":0},{"name":"Olle","attendance":1,"goals":7,"assists":1,"cleanSheet":11,"turbotorped":0}]},{"week":45,"date":"2025-11-06","stats":[{"name":"Martin J","attendance":1,"goals":1,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Love B","attendance":1,"goals":2,"assists":2,"cleanSheet":11,"turbotorped":0},{"name":"Lasse","attendance":1,"goals":6,"assists":0,"cleanSheet":4,"turbotorped":1},{"name":"Anton","attendance":1,"goals":0,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Malte","attendance":1,"goals":7,"assists":5,"cleanSheet":11,"turbotorped":0},{"name":"Gurra","attendance":1,"goals":0,"assists":4,"cleanSheet":4,"turbotorped":0},{"name":"Erik √ñ","attendance":1,"goals":3,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Degen","attendance":1,"goals":1,"assists":3,"cleanSheet":11,"turbotorped":0},{"name":"Marco","attendance":1,"goals":2,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Chris","attendance":1,"goals":2,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Simon A","attendance":1,"goals":5,"assists":0,"cleanSheet":11,"turbotorped":0},{"name":"Arvid","attendance":1,"goals":1,"assists":2,"cleanSheet":4,"turbotorped":0},{"name":"Olle","attendance":1,"goals":3,"assists":1,"cleanSheet":5,"turbotorped":0},{"name":"Andreas B","attendance":1,"goals":2,"assists":1,"cleanSheet":11,"turbotorped":0},{"name":"Adde","attendance":1,"goals":0,"assists":1,"cleanSheet":4,"turbotorped":0},{"name":"Gio","attendance":1,"goals":0,"assists":0,"cleanSheet":5,"turbotorped":0},{"name":"Emil V","attendance":1,"goals":2,"assists":4,"cleanSheet":11,"turbotorped":0},{"name":"Esmet","attendance":1,"goals":0,"assists":0,"cleanSheet":4,"turbotorped":0},{"name":"Johnson","attendance":1,"goals":0,"assists":3,"cleanSheet":5,"turbotorped":0},{"name":"Ante","attendance":1,"goals":9,"assists":8,"cleanSheet":11,"turbotorped":0}]}];
/* ------- NEW: merge Tue/Thu entries per ISO date within a week ------- */
function formatPracticeDate(iso){
  const d = new Date(iso + 'T00:00:00Z');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[d.getUTCMonth()]} ${d.getUTCDate()}`;
}
function renderStars(n){ return n > 0 ? '‚≠ê'.repeat(n) : ''; }
function getPractices(){
  return weeklyData
    .map(entry => ({
      date: entry.date,
      label: formatPracticeDate(entry.date),
      stats: entry.stats
    }))
    .sort((a,b) => a.date.localeCompare(b.date));
}
const practices = getPractices();

let currentView='total';
let currentPractice=practices.length-1;

/* ------- Helpers ------- */
function calculateTotalStats(){
  const playerStats={};
  practices.forEach(practice=>{
    practice.stats.forEach(p=>{
      if(!playerStats[p.name]){
        playerStats[p.name]={attendance:0,goals:0,assists:0,cleanSheets:0,turbotorped:0,practiceData:[]};
      }
      playerStats[p.name].attendance+=p.attendance;
      playerStats[p.name].goals+=p.goals;
      playerStats[p.name].assists+=p.assists;
      playerStats[p.name].cleanSheets+=p.cleanSheet;
      playerStats[p.name].turbotorped+=p.turbotorped;
      playerStats[p.name].practiceData.push({date:practice.date,...p});
    });
  });
  return playerStats;
}
function calculatePoints(s){return s.attendance+s.goals+s.assists+s.cleanSheets+(s.turbotorped*5)}

/* ------- Renderers ------- */
function renderLeaderboard(){
  const stats=calculateTotalStats();
  const leaderboard=Object.entries(stats)
    .map(([name,s])=>({name,...s,points:calculatePoints(s)}))
    .sort((a,b)=>b.points-a.points);

// Previous ranks (up/down)
  let previousRankings={};
  if(practices.length>1){
    const prev={};
    practices.slice(0,-1).forEach(practice=>{
      practice.stats.forEach(p=>{
        if(!prev[p.name]) prev[p.name]={attendance:0,goals:0,assists:0,cleanSheets:0,turbotorped:0};
        prev[p.name].attendance+=p.attendance;
        prev[p.name].goals+=p.goals;
        prev[p.name].assists+=p.assists;
        prev[p.name].cleanSheets+=p.cleanSheet;
        prev[p.name].turbotorped+=p.turbotorped;
      })
    });
    const prevBoard=Object.entries(prev).map(([name,s])=>({name,points:calculatePoints(s)})).sort((a,b)=>b.points-a.points);
    prevBoard.forEach((p,i)=>previousRankings[p.name]=i+1);
  }

  const tbody=document.getElementById('leaderboardBody');
  tbody.innerHTML = leaderboard.map((p,i)=>{
    const currentRank=i+1, prevRank=previousRankings[p.name];
    let delta='';
    if(prevRank){
      const d=prevRank-currentRank;
      if(d>0) delta=`<span class="rank-change rank-up">‚ñ≤${d}</span>`;
      else if(d<0) delta=`<span class="rank-change rank-down">‚ñº${Math.abs(d)}</span>`;
    }
    return `<tr>
      <td>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:nowrap;">
          <span class="rank">${currentRank}</span>${delta}
        </div>
      </td>
      <td><span class="player-name">${p.name}</span></td>
      <td><span class="points">${p.points}</span></td>
      <td>${p.attendance}</td><td>${p.goals}</td><td>${p.assists}</td><td>${p.cleanSheets}</td><td>${p.turbotorped}</td>
    </tr>`;
  }).join('');

  // Aside overview ring
  const practicesPlayed=practices.length;
  const targetPractices=50;
  const pct=Math.round((practicesPlayed/targetPractices)*100);
  const ring=document.getElementById('seasonRing');
  const pctEl=document.getElementById('seasonPct');
  document.getElementById('weeksText').textContent=`${practicesPlayed} of ${targetPractices} practices`;
  ring.style.setProperty('--p', pct);
  pctEl.textContent=pct+'%';

  return leaderboard;
}
function calculateStreaks(playerStats){
  const streaks=[];

  // Sort all practices chronologically
  const sortedPractices = practices.slice().sort((a,b) => a.date.localeCompare(b.date));

  Object.entries(playerStats).forEach(([name,stats])=>{
    // attendance streak - count backwards from most recent practice
    let currentA=0;
    for(let i=sortedPractices.length-1; i>=0; i--){
      const practiceStats = sortedPractices[i].stats.find(p => p.name === name);
      if(practiceStats && practiceStats.attendance>0) {
        currentA++;
      } else {
        break; // streak broken
      }
    }

    // contribution streak - count backwards from most recent practice
    let currentC=0;
    for(let i=sortedPractices.length-1; i>=0; i--){
      const practiceStats = sortedPractices[i].stats.find(p => p.name === name);
      if(practiceStats && (practiceStats.goals>0 || practiceStats.assists>0)) {
        currentC++;
      } else {
        break; // streak broken
      }
    }

    // Only include if at least one streak is 3+
    if(currentA>=3 || currentC>=3) {
      streaks.push({name,currentAttendance:currentA,currentContribution:currentC});
    }
  });
  return streaks;
}
function renderActiveStreaks(){
  const s=calculateStreaks(calculateTotalStats());
  const active=s.sort((a,b)=>(b.currentAttendance+b.currentContribution)-(a.currentAttendance+a.currentContribution));
  const el=document.getElementById('activeStreaks');
  if(active.length===0){ el.innerHTML='<div class="empty-state">No active streaks (3+ practices)</div>'; return; }
  el.innerHTML=active.map(st=>{
    const lines=[];
    if(st.currentAttendance>=3) lines.push(`üéØ ${st.currentAttendance} practice${st.currentAttendance>1?'s':''} attendance`);
    if(st.currentContribution>=3) lines.push(`‚öΩ ${st.currentContribution} practice${st.currentContribution>1?'s':''} contributing`);
    return `
    <div class="metric-item">
      <div class="metric-player">${st.name}</div>
      <div class="metric-value">${lines.join('<br>')}</div>
    </div>`;
  }).join('');
}
function renderHotStreak(){
  const stats=calculateTotalStats();

  // Get the last 3 practices chronologically
  const sortedPractices = practices.slice().sort((a,b) => a.date.localeCompare(b.date));
  const lastThreePractices = sortedPractices.slice(-3);

  if(lastThreePractices.length < 3) {
    document.getElementById('hotStreak').innerHTML='<div class="empty-state">Need at least 3 practices</div>';
    return;
  }

  const form = Object.keys(stats).map(name => {
    let pts = 0;
    let practicesPlayed = 0;

    lastThreePractices.forEach(practice => {
      const playerStats = practice.stats.find(p => p.name === name);
      if(playerStats && playerStats.attendance > 0) {
        practicesPlayed++;
        pts += playerStats.attendance + playerStats.goals + playerStats.assists +
               playerStats.cleanSheet + (playerStats.turbotorped * 5);
      }
    });

    return {name, recentPoints: pts, practicesPlayed};
  }).filter(p => p.practicesPlayed >= 2) // Must have played at least 2 of last 3
    .sort((a,b) => b.recentPoints - a.recentPoints);

  const el = document.getElementById('hotStreak');
  if(form.length === 0) {
    el.innerHTML = '<div class="empty-state">Not enough data yet</div>';
    return;
  }

  const top = form[0];
  el.innerHTML = `<div class="hot-streak"><div class="hot-streak-player">üî• ${top.name}</div><div class="hot-streak-desc">${top.recentPoints} points in last 3 practices (played ${top.practicesPlayed})</div></div>`;
}
function renderMilestones(){
  const ps=calculateTotalStats();
  const out=[];
  const th={goals:[1,5,10,25,50],assists:[1,5,10,25],points:[10,25,50,100],attendance:[5,10,20]};

  if(practices.length===0) {
    document.getElementById('milestones').innerHTML='<div class="empty-state">No practices yet</div>';
    return;
  }

  const latestPracticeDate = practices[practices.length-1].date;
  const latestPracticePlayers = new Set(practices[practices.length-1].stats.map(p=>p.name));

  Object.entries(ps).forEach(([name,s])=>{
    // Only check players who participated in the latest practice
    if(!latestPracticePlayers.has(name)) return;

    const latestPractice = s.practiceData.find(p=>p.date===latestPracticeDate);
    if(!latestPractice) return;

    // Calculate stats before the latest practice
    const prevPractices = s.practiceData.filter(p=>p.date < latestPracticeDate);
    const prevGoals = prevPractices.reduce((sum,p)=>sum+p.goals,0);
    const prevAssists = prevPractices.reduce((sum,p)=>sum+p.assists,0);
    const prevAttendance = prevPractices.reduce((sum,p)=>sum+p.attendance,0);
    const prevPoints = prevPractices.reduce((sum,p)=>sum+p.attendance+p.goals+p.assists+p.cleanSheet+(p.turbotorped*5),0);

    // Check goals
    th.goals.forEach(t=>{ if(s.goals>=t && prevGoals<t) out.push({name,type:'Goals',value:t}); });
    // Check assists
    th.assists.forEach(t=>{ if(s.assists>=t && prevAssists<t) out.push({name,type:'Assists',value:t}); });
    // Check attendance
    th.attendance.forEach(t=>{ if(s.attendance>=t && prevAttendance<t) out.push({name,type:'Attendance',value:t}); });
    // Check points
    const totalPoints = calculatePoints(s);
    th.points.forEach(t=>{ if(totalPoints>=t && prevPoints<t) out.push({name,type:'Points',value:t}); });
  });

  const el=document.getElementById('milestones');
  if(out.length===0){
    el.innerHTML='<div class="empty-state">No recent milestones</div>';
  } else {
    out.sort((a,b)=>b.value-a.value);
    el.innerHTML = out.map(m=>`
      <div class="metric-item"><div class="metric-player">${m.name}</div><div class="metric-value">üéâ ${m.value} ${m.type}</div></div>`).join('');
  }
}
function renderBiggestClimber(){
  const ps=calculateTotalStats();
  if(practices.length<2){ document.getElementById('biggestClimber').innerHTML='<div class="empty-state">Need more practices</div>'; return;}
  const prev={};
  practices.slice(0,-1).forEach(practice=>practice.stats.forEach(p=>{
    if(!prev[p.name]) prev[p.name]={attendance:0,goals:0,assists:0,cleanSheets:0,turbotorped:0};
    prev[p.name].attendance+=p.attendance; prev[p.name].goals+=p.goals; prev[p.name].assists+=p.assists; prev[p.name].cleanSheets+=p.cleanSheet; prev[p.name].turbotorped+=p.turbotorped;
  }));
  const prevL=Object.entries(prev).map(([name,s])=>({name,points:calculatePoints(s)})).sort((a,b)=>b.points-a.points);
  const prevRanks={}; prevL.forEach((p,i)=>prevRanks[p.name]=i+1);
  const currentL=Object.entries(ps).map(([name,s])=>({name,points:calculatePoints(s)})).sort((a,b)=>b.points-a.points);
  let win=null,climb=0;
  currentL.forEach((p,i)=>{
    const r=i+1, pr=prevRanks[p.name];
    if(pr){ // Only count players who existed before (not new players)
      const d=pr-r;
      if(d>climb){climb=d; win=p.name;}
    }
  });
  const el=document.getElementById('biggestClimber');
  el.innerHTML = (!win || climb===0) ? '<div class="empty-state">No significant rank changes</div>' :
    `<div class="metric-item"><div class="metric-player">${win}</div><div class="metric-value">üìà Climbed ${climb} position${climb>1?'s':''}</div></div>`;
}
function renderSeasonStats(){
  const ps=calculateTotalStats();
  const goals=Object.values(ps).reduce((s,p)=>s+p.goals,0);
  const practiceCount=practices.length; const players=Object.keys(ps).length;
  const el=document.getElementById('seasonStats');
  el.innerHTML = `
    <div class="metric-item"><div class="metric-player">Total Practices</div><div class="metric-value">${practiceCount}</div></div>
    <div class="metric-item"><div class="metric-player">Total Players</div><div class="metric-value">${players}</div></div>
    <div class="metric-item"><div class="metric-player">Total Goals</div><div class="metric-value">${goals}</div></div>`;
}
function populatePracticeSelector(){
  const sel=document.getElementById('weekSelect');
  sel.innerHTML = practices.map((practice,i)=>{
    return `<option value="${i}">${practice.label}</option>`;
  }).reverse().join('');
  sel.value=currentPractice;
}
function calculateAverageHistoricalCS(playerName, allPractices, currentPracticeDate, minPractices = 2, minTotalPractices = 5){
  const ps = calculateTotalStats();
  const playerData = ps[playerName];
  if(!playerData) return 0;

  // Only enforce minimum attendance if we have enough total practices in the season
  if(allPractices.length >= minTotalPractices && playerData.attendance < minPractices) {
    return 0;
  }

  // Get player's HISTORICAL practice data (exclude current practice)
  const historicalPractices = [...playerData.practiceData]
    .filter(p => p.date !== currentPracticeDate);

  if(historicalPractices.length === 0) return 0;

  // Simple average of all historical clean sheets
  const totalCS = historicalPractices.reduce((sum, p) => sum + p.cleanSheet, 0);
  return totalCS / historicalPractices.length;
}
/* ------- Deviation Leader (Negative-Binomial z-score) ------- */
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
function sampleVariance(arr, m){
  if(arr.length < 2) return 0;
  const s = arr.reduce((acc,x)=>acc+(x-m)*(x-m), 0);
  return s/(arr.length-1);
}
function nbPredictiveSD(mu, v){
  // NB variance: mu + mu^2 / R, with R = mu^2 / (v - mu) when v>mu; else Poisson
  if(!(v > mu)) return Math.sqrt(Math.max(mu, 1e-9)); // Poisson-ish or underdispersed
  const denom = Math.max(v - mu, 1e-9);
  const R = Math.max((mu*mu)/denom, 0.1); // small floor for stability
  return Math.sqrt(mu + (mu*mu)/R);
}
function renderDeviationLeaderForPractice(practice){
  const practiceDate = practice.date;
  const sortedPractices = practices.slice().sort((a,b)=>a.date.localeCompare(b.date));
  const priorPractices = sortedPractices.filter(pr => pr.date < practiceDate);

  console.log('=== BREAKOUT SPOTLIGHT DEBUG ===');
  console.log(`Practice date: ${practiceDate} | Prior practices: ${priorPractices.length}`);

  if(priorPractices.length === 0){
    console.log('No prior practices ‚Üí cannot compute deviations.');
    document.getElementById('deviationLeader').innerHTML =
      '<div class="empty-state">Need earlier practices to compare against</div>';
    return;
  }

  const candidates = practice.stats.map(p => {
    // Build GA history for this player
    const historyGA = [];
    priorPractices.forEach(pr => {
      const row = pr.stats.find(r => r.name === p.name);
      if(row && row.attendance > 0){
        historyGA.push((row.goals||0) + (row.assists||0));
      }
    });

    const n = historyGA.length;
    const currGA = (p.goals||0) + (p.assists||0);

    if(n < 2){
      console.log(`(skip) ${p.name}: insufficient history (n=${n}), currGA=${currGA}`);
      return null; // need variance estimate
    }

    const mu = mean(historyGA);
    const v  = sampleVariance(historyGA, mu);
    const sd = nbPredictiveSD(mu, v);         // per-player dispersion (no shrink)
    const z  = (currGA - mu) / (sd || 1e-9);

    console.log(`${p.name}: n=${n}, mu=${mu.toFixed(3)}, var=${v.toFixed(3)}, sd=${sd.toFixed(3)}, currGA=${currGA}, z=${isFinite(z)?z.toFixed(3):'NA'}`);

    return { name: p.name, z, currGA, mu, n };
  }).filter(Boolean).filter(x => isFinite(x.z) && x.z > 0);

  if(candidates.length === 0){
    console.log('No positive deviations this practice.');
    document.getElementById('deviationLeader').innerHTML =
      '<div class="empty-state">No one beat their usual this practice</div>';
    return;
  }

  // Sort by z desc and pick the top
  candidates.sort((a,b)=>b.z - a.z);
  const top = candidates[0];

  console.log('Top breakout:', {
    name: top.name,
    z: Number(top.z.toFixed(3)),
    currGA: top.currGA,
    mu: Number(top.mu.toFixed(3)),
    n: top.n
  });

  const lift  = top.currGA - top.mu;
  const ratio = top.mu > 0 ? (top.currGA / top.mu) : top.currGA;

    let level = '';
    if (top.z > 3.5) {
      level = 'Godlike';
    } else if (top.z > 2.5) {
      level = 'On Fire';
    } else if (top.z > 1.5) {
      level = 'Breakout';
    } else {
      level = 'Steady';
    }

    document.getElementById('deviationLeader').innerHTML = `
      <div class="hot-streak" title="Compares today to the player‚Äôs own past practices, adjusting for how steady or streaky they usually are.">
        <div class="hot-streak-player">
          ${level === 'Godlike' ? '‚ö°' : level === 'On Fire' ? 'üî•' : level === 'Breakout' ? '‚ú®' : 'üèí'}
          ${top.name}
        </div>
        <div class="hot-streak-desc">
          <strong>${level}</strong>: ${top.currGA} goal contributions
          <span style="color:var(--muted)"> ‚Ä¢ usually ${top.mu.toFixed(1)}</span><br/>
          (<span>+${top.z.toFixed(2)}</span> standard deviations)<br/>
          <span style="color:var(--muted-2)">Based on ${top.n} earlier practices</span>
        </div>
      </div>
    `;
}


function pickPracticeTopTeam(practice){
  const players = practice.stats
    .filter(p => p.attendance > 0)
    .map(p => ({
      ...p,
      ga: p.goals + p.assists,
      practicePoints: p.attendance + p.goals + p.assists + p.cleanSheet + (p.turbotorped * 5)
    }));

  const taken = new Set();
  const team = [];

  // --- Attackers: top 2 by GA (tie-break goals, then points) ---
  const byGA = [...players].sort((a,b) =>
    (b.ga - a.ga) || (b.goals - a.goals) || (b.practicePoints - a.practicePoints)
  );
  for (const p of byGA) {
    if (!taken.has(p.name)) { team.push({...p, role:'ATT'}); taken.add(p.name); }
    if (team.filter(x=>x.role==='ATT').length === 2) break;
  }

  // --- Defenders: current practice CS + normalized weighted historical CS ---
  const currentPracticeDate = practice.date;
  const maxHistoricalWeight = 0.3; // Maximum weight for players with many practices

  const playersWithDefenseScore = players.map(p => {
    const ps = calculateTotalStats();
    const playerData = ps[p.name];
    const historicalCount = playerData ? playerData.practiceData.filter(pr => pr.date !== currentPracticeDate).length : 0;

    // Weight scales with number of historical practices: 0.3 √ó (1 - e^(-n/3))
    const historicalWeight = historicalCount > 0 ? maxHistoricalWeight * (1 - Math.exp(-historicalCount / 3)) : 0;

    const historicalCS = calculateAverageHistoricalCS(p.name, practices, currentPracticeDate);

    return {
      ...p,
      historicalWeightedCS: historicalCS,
      historicalWeight: historicalWeight,
      totalDefenseScore: p.cleanSheet + (historicalWeight * historicalCS)
    };
  });

  // Debug logging
  console.log('=== DEFENDER SELECTION DEBUG ===');
  playersWithDefenseScore.forEach(p => {
    console.log(`${p.name}: currentCS=${p.cleanSheet}, historicalCS=${p.historicalWeightedCS.toFixed(2)}, totalScore=${p.totalDefenseScore.toFixed(2)}, points=${p.practicePoints}`);
  });

  const byCS = [...playersWithDefenseScore].sort((a,b) =>
    (b.totalDefenseScore - a.totalDefenseScore) || (b.practicePoints - a.practicePoints)
  );

  console.log('Top defenders selected:', byCS.slice(0,2).map(p => p.name));
  for (const p of byCS) {
    if (!taken.has(p.name)) { team.push({...p, role:'DEF'}); taken.add(p.name); }
    if (team.filter(x=>x.role==='DEF').length === 2) break;
  }

  // --- Fifth: best remaining by practice points (tie-break GA, then goals) ---
  const byPts = [...players].sort((a,b) =>
    (b.practicePoints - a.practicePoints) || (b.ga - a.ga) || (b.goals - a.goals)
  );
  for (const p of byPts) {
    if (!taken.has(p.name)) { team.push({...p, role:'MVP'}); taken.add(p.name); break; }
  }

  // Fallbacks
  if (team.length < 5) {
    for (const p of byPts) {
      if (!taken.has(p.name)) { team.push({...p, role:'FLEX'}); taken.add(p.name); }
      if (team.length === 5) break;
    }
  }

  return team.slice(0,5);
}
function updatePracticeView(){
  currentPractice=parseInt(document.getElementById('weekSelect').value);
  const practice=practices[currentPractice];
  renderDeviationLeaderForPractice(practice);
  const tbody=document.getElementById('weeklyStatsBody');

  tbody.innerHTML = practice.stats.map(p=>{
    const pts=p.attendance+p.goals+p.assists+p.cleanSheet+(p.turbotorped*5);
    return `<tr>
      <td><span class="player-name">${p.name}</span></td>
      <td>${p.goals}</td>
      <td>${p.assists}</td>
      <td>${p.cleanSheet}</td>
      <td>${renderStars(p.turbotorped)}</td>
      <td><span class="points">${pts}</span></td>
    </tr>`;
  }).join('');

  const team = pickPracticeTopTeam(practice);
  document.getElementById('weeklyTeam').innerHTML = `
    <div class="weekly-team">
      ${team.map(p => {
        let tooltip = '';
        if(p.role === 'ATT') tooltip = 'Selected by: Goals + Assists';
        else if(p.role === 'DEF') {
          const hist = p.historicalWeightedCS ? p.historicalWeightedCS.toFixed(1) : '0.0';
          tooltip = `Selected by: ${p.cleanSheet} CS (current) + ${hist} CS (avg history) √ó 0.3`;
        }
        else tooltip = 'Selected by: Highest remaining points';

        return `
        <div class="team-player" title="${tooltip}">
          <div class="team-player-name">${p.name}</div>
          <div class="team-player-stats">
            ${p.role === 'ATT' ? 'ATT' : (p.role === 'DEF' ? 'DEF' : '‚òÖ')}
            ‚Ä¢ ${p.goals}G ${p.assists}A
            ‚Ä¢ ${p.cleanSheet}CS
            ${p.turbotorped ? '‚Ä¢ ' + renderStars(p.turbotorped) : ''}
          </div>
        </div>
      `}).join('')}
    </div>`;

  const prevNames=new Set(); practices.slice(0,currentPractice).forEach(practice=>practice.stats.forEach(p=>prevNames.add(p.name)));
  const newcomers=practice.stats.filter(p=>!prevNames.has(p.name));
  const np=document.getElementById('newPlayers');
  np.innerHTML = newcomers.length? newcomers.map(p=>`<div class="metric-item"><div class="metric-player new-player">üÜï ${p.name}</div></div>`).join('') : '<div class="empty-state">No new players this practice</div>';
}
function showView(view){
  document.getElementById('totalView').style.display = (view==='total')?'block':'none';
  document.getElementById('weeklyView').style.display = (view==='weekly')?'block':'none';
  document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  if(view==='total'){
    renderLeaderboard(); renderActiveStreaks(); renderHotStreak(); renderMilestones(); renderBiggestClimber(); renderSeasonStats();
  }else{
    populatePracticeSelector(); updatePracticeView();
  }
}

/* Initial paint */
renderLeaderboard();
renderActiveStreaks();
renderHotStreak();
renderMilestones();
renderBiggestClimber();
renderSeasonStats();
populatePracticeSelector();
</script>
</body>
</html>
